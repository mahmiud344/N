<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙƒØ§ØªØ¨ ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    button {
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 10px;
    }
    button.delete {
      background-color: red;
    }
    .office {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .office h3 {
      cursor: pointer;
      color: #007bff;
      margin: 0;
    }
    .details {
      margin-top: 10px;
    }
    input, textarea {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    .product {
      background: #f9f9f9;
      border: 1px dashed #aaa;
      padding: 10px;
      border-radius: 8px;
      margin-top: 10px;
    }
    .productForm, .products {
      margin-top: 15px;
      display: none;
    }
    a {
      color: #007bff;
    }
    img.product-image {
      max-width: 100px;
      display: block;
      margin-bottom: 8px;
      border-radius: 6px;
    }
    .loading {
      display: inline-block;
      margin-right: 10px;
      color: #666;
    }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, doc, getDocs, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { 
      getStorage, ref, uploadBytes, getDownloadURL, deleteObject
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDx28eWz-H6QWyOeu6BPbYw5zQ3TEpAOOA",
      authDomain: "webweb-19f1e.firebaseapp.com",
      projectId: "webweb-19f1e",
      storageBucket: "webweb-19f1e.appspot.com",
      messagingSenderId: "418636654072",
      appId: "1:418636654072:web:39a21734e91fb13262e20d",
      measurementId: "G-0GH2TLYNZ8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    window.addOffice = async function () {
      const name = document.getElementById('officeName').value.trim();
      const address = document.getElementById('officeAddress').value.trim();
      const phone = document.getElementById('officePhone').value.trim();
      const contact = document.getElementById('officeContact').value.trim();
      const link = document.getElementById('officeLink').value.trim();

      if (!name) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØªØ¨");

      const officeData = { name, address, phone, contact, link };

      try {
        const officeRef = await addDoc(collection(db, "offices"), officeData);
        window.createOfficeElement(officeRef.id, officeData);

        // Ù…Ø³Ø­ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        document.getElementById('officeName').value = '';
        document.getElementById('officeAddress').value = '';
        document.getElementById('officePhone').value = '';
        document.getElementById('officeContact').value = '';
        document.getElementById('officeLink').value = '';
        
        document.getElementById('officeForm').style.display = 'none';
      } catch (error) {
        alert("ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙƒØªØ¨: " + error.message);
      }
    };

    window.createOfficeElement = function (id, data) {
      const officeDiv = document.createElement('div');
      officeDiv.className = "office";
      officeDiv.dataset.id = id;

      officeDiv.innerHTML = `
        <h3 onclick="toggleOfficeDetails(this)">${data.name}</h3>
        <div class="details">
          <p><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${data.address || ''}</p>
          <p><strong>Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„:</strong> ${data.phone || ''}</p>
          <p><strong>Ø§ØªØµØ§Ù„ Ø¢Ø®Ø±:</strong> ${data.contact || ''}</p>
          <p><strong>Ø±Ø§Ø¨Ø·:</strong> <a href="${data.link || '#'}" target="_blank">${data.link || ''}</a></p>
          <button onclick="showProductForm(this)">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</button>
          <button onclick="deleteOffice(this)" class="delete">ğŸ—‘ Ø­Ø°Ù Ø§Ù„Ù…ÙƒØªØ¨</button>
          <div class="productForm">
            <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" />
            <textarea placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª"></textarea>
            <input type="file" accept="image/*" />
            <button onclick="addProduct(this)">ğŸ“¥ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬</button>
          </div>
          <div class="products"></div>
        </div>
      `;

      document.getElementById('officesContainer').appendChild(officeDiv);
    };

    window.showProductForm = function (btn) {
      const form = btn.nextElementSibling.nextElementSibling;
      form.style.display = form.style.display === 'block' ? 'none' : 'block';
    };

    window.toggleOfficeDetails = function (title) {
      const details = title.nextElementSibling;
      const products = details.querySelector('.products');
      products.style.display = products.style.display === 'block' ? 'none' : 'block';
    };

    window.addProduct = async function (btn) {
      const form = btn.parentElement;
      const name = form.querySelector('input[type="text"]').value.trim();
      const notes = form.querySelector('textarea').value.trim();
      const fileInput = form.querySelector('input[type="file"]');
      const imageFile = fileInput.files[0];

      if (!name) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬");

      const officeDiv = form.closest('.office');
      const officeId = officeDiv.dataset.id;
      const productsContainer = officeDiv.querySelector('.products');

      // Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
      btn.disabled = true;
      let loadingSpan = document.createElement('span');
      loadingSpan.className = 'loading';
      loadingSpan.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
      btn.parentNode.insertBefore(loadingSpan, btn);

      try {
        let imageData = "";

        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Base64 Ø¥Ø°Ø§ ØªÙ… Ø§Ø®ØªÙŠØ§Ø±Ù‡Ø§
        if (imageFile) {
          // Ø¶ØºØ· ÙˆØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Ù‚Ù…Ø§Ø´ Canvas
          imageData = await new Promise((resolve, reject) => {
            try {
              const img = new Image();
              const canvas = document.createElement('canvas');
              const ctx = canvas.getContext('2d');
              
              img.onload = function() {
                // Ø¶ØºØ· Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø©
                let width = img.width;
                let height = img.height;
                
                // ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø¬Ù… Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ±Ø©
                const maxSize = 600;
                if (width > maxSize || height > maxSize) {
                  if (width > height) {
                    height = Math.round(height * (maxSize / width));
                    width = maxSize;
                  } else {
                    width = Math.round(width * (maxSize / height));
                    height = maxSize;
                  }
                }
                
                canvas.width = width;
                canvas.height = height;
                
                // Ø±Ø³Ù… Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¶ØºÙˆØ·Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ù…Ø§Ø´
                ctx.drawImage(img, 0, 0, width, height);
                
                // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Base64 Ù…Ø¹ Ø¬ÙˆØ¯Ø© 0.7 (70%)
                const compressedImage = canvas.toDataURL('image/jpeg', 0.7);
                resolve(compressedImage);
              };
              
              img.onerror = function() {
                reject(new Error("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©"));
              };
              
              // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ URL Ù…Ø¤Ù‚Øª
              const url = URL.createObjectURL(imageFile);
              img.src = url;
            } catch (e) {
              reject(e);
            }
          });
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ø¹ Ø§Ù„ØµÙˆØ±Ø©
        const product = { name, notes, imageData };
        
        // Ø­ÙØ¸ ÙÙŠ Firestore
        const productRef = await addDoc(collection(doc(db, "offices", officeId), "products"), product);
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        renderProduct(productsContainer, product, productRef.id);

        // Ù…Ø³Ø­ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        form.querySelector('input[type="text"]').value = '';
        form.querySelector('textarea').value = '';
        form.querySelector('input[type="file"]').value = '';
        
        form.style.display = 'none';
      } catch (error) {
        alert("Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬: " + error.message);
        console.error(error);
      } finally {
        // Ø¥Ø²Ø§Ù„Ø© Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        btn.disabled = false;
        if (loadingSpan) loadingSpan.remove();
      }
    };

    function renderProduct(container, product, id = null) {
      const div = document.createElement('div');
      div.className = "product";
      if (id) div.dataset.id = id;
      div.innerHTML = `
        ${product.imageData ? `<img src="${product.imageData}" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬" class="product-image" />` : ''}
        <strong>${product.name}</strong>
        <p>${product.notes || ''}</p>
        <button onclick="deleteProduct(this)" class="delete">ğŸ—‘ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬</button>
      `;
      container.appendChild(div);
    }

    window.deleteProduct = async function (btn) {
      const productDiv = btn.closest(".product");
      const productId = productDiv.dataset.id;
      const officeDiv = btn.closest(".office");
      const officeId = officeDiv.dataset.id;

      if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ")) return;

      try {
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØµÙˆØ±Ø©
        const productDoc = await getDocs(collection(doc(db, "offices", officeId), "products"));
        for (const doc of productDoc.docs) {
          if (doc.id === productId) {
            const productData = doc.data();
            
            // Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
            if (productData.imageUrl) {
              // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
              const imageUrlPath = decodeURIComponent(productData.imageUrl.split('/o/')[1].split('?')[0]);
              const imageRef = ref(storage, imageUrlPath);
              try {
                await deleteObject(imageRef);
              } catch (imageError) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø©:", imageError);
              }
            }
            break;
          }
        }

        // Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Firestore
        await deleteDoc(doc(db, "offices", officeId, "products", productId));
        productDiv.remove();
      } catch (error) {
        alert("Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬: " + error.message);
      }
    };

    window.deleteOffice = async function (btn) {
      const officeDiv = btn.closest(".office");
      const officeId = officeDiv.dataset.id;

      if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ÙƒØªØ¨ ÙˆÙƒÙ„ Ù…Ù†ØªØ¬Ø§ØªÙ‡ØŸ")) return;

      try {
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ÙƒØªØ¨
        const productsSnap = await getDocs(collection(doc(db, "offices", officeId), "products"));
        
        // Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø§
        for (const productDoc of productsSnap.docs) {
          const productData = productDoc.data();
          
          // Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
          if (productData.imageUrl) {
            const imageUrlPath = decodeURIComponent(productData.imageUrl.split('/o/')[1].split('?')[0]);
            const imageRef = ref(storage, imageUrlPath);
            try {
              await deleteObject(imageRef);
            } catch (imageError) {
              console.error("Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬:", imageError);
            }
          }
          
          // Ø­Ø°Ù ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù…Ù†ØªØ¬
          await deleteDoc(productDoc.ref);
        }
        
        // Ø­Ø°Ù Ø§Ù„Ù…ÙƒØªØ¨
        await deleteDoc(doc(db, "offices", officeId));
        officeDiv.remove();
      } catch (error) {
        alert("Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…ÙƒØªØ¨: " + error.message);
      }
    };

    window.loadOffices = async function () {
      try {
        // ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙƒØ§ØªØ¨
        const snapshot = await getDocs(collection(db, "offices"));
        for (const docSnap of snapshot.docs) {
          const data = docSnap.data();
          createOfficeElement(docSnap.id, data);
          
          // ØªØ­Ù…ÙŠÙ„ Ù…Ù†ØªØ¬Ø§Øª ÙƒÙ„ Ù…ÙƒØªØ¨
          const productsSnapshot = await getDocs(collection(doc(db, "offices", docSnap.id), "products"));
          const officeDiv = document.querySelector(`.office[data-id="${docSnap.id}"]`);
          const productsContainer = officeDiv.querySelector('.products');
          
          // Ø¹Ø±Ø¶ ÙƒÙ„ Ù…Ù†ØªØ¬
          for (const productDoc of productsSnapshot.docs) {
            renderProduct(productsContainer, productDoc.data(), productDoc.id);
          }
        }
      } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);
        alert("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + error.message);
      }
    };

    // ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    window.addEventListener('DOMContentLoaded', loadOffices);
  </script>
</head>
<body>
  <h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙƒØ§ØªØ¨ ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª</h1>
  <button onclick="document.getElementById('officeForm').style.display = 'block'">â• Ø¥Ø¶Ø§ÙØ© Ù…ÙƒØªØ¨ Ø¬Ø¯ÙŠØ¯</button>

  <div id="officeForm" style="display:none; margin-top:15px;">
    <input type="text" id="officeName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØªØ¨" />
    <input type="text" id="officeAddress" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" />
    <input type="text" id="officePhone" placeholder="Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„" />
    <input type="text" id="officeContact" placeholder="Ø§ØªØµØ§Ù„ Ø¢Ø®Ø±" />
    <input type="url" id="officeLink" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹" />
    <button onclick="addOffice()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…ÙƒØªØ¨</button>
  </div>

  <div id="officesContainer" style="margin-top:20px;"></div>
</body>
</html>
